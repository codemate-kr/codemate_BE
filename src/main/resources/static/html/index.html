<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Refresh Flow Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; }
    .row { display: flex; gap: 12px; margin-bottom: 12px; align-items: center; flex-wrap: wrap; }
    input, button { padding: 8px 12px; font-size: 14px; }
    #log { white-space: pre-wrap; background: #111; color: #ddd; padding: 12px; border-radius: 8px; min-height: 160px; }
    code { background: #f3f3f3; padding: 2px 6px; border-radius: 4px; }
  </style>
</head>
<body>
<h1>Access/Refresh í† í° í”Œë¡œìš° í…ŒìŠ¤íŠ¸</h1>

<div class="row">
  <label>API Base URL:</label>
  <input id="baseUrl" size="40" value="http://localhost:8080" />
</div>

<div class="row">
  <button id="btnLogin">1) ë¸Œë¼ìš°ì €ë¡œ êµ¬ê¸€ ë¡œê·¸ì¸ ì‹œì‘</button>
  <span>â†’ ì„±ê³µ ì‹œ ì„œë²„ì˜ SuccessHandlerê°€ <code>Set-Cookie: refreshToken</code> ë‚´ë ¤ì¤Œ</span>
</div>

<div class="row">
  <button id="btnCall">2) ë³´í˜¸ API í˜¸ì¶œ</button>
  <!-- ğŸ”¥ ì—¬ê¸° ê¸°ë³¸ê°’ì„ recommend APIë¡œ ë³€ê²½ -->
  <input id="protectedPath" size="60" value="/api/problem/recommend?handle=test_handle&count=3" />
  <span>í—¤ë”ì— <code>Authorization: Bearer &lt;accessToken&gt;</code></span>
</div>

<div class="row">
  <button id="btnExpire">ê°•ì œë¡œ AT ë¹„ìš°ê¸°(ë§Œë£Œ ì‹œë®¬ë ˆì´ì…˜)</button>
  <button id="btnRefresh">/auth/refresh ì§ì ‘ í˜¸ì¶œ</button>
</div>

<div class="row">
  <button id="btnShowCookies">í˜„ì¬ ì¿ í‚¤ ë³´ê¸°(ë„ë©”ì¸ ê¸°ì¤€)</button>
  <small>â€» HttpOnly ì¿ í‚¤ ê°’ì€ JSë¡œ ì½ì„ ìˆ˜ ì—†ìŒ(ì •ìƒ ë™ì‘)</small>
</div>

<h3>ë©”ëª¨ë¦¬ ì €ì¥ëœ AccessToken</h3>
<div class="row">
  <code id="atPreview">(ì—†ìŒ)</code>
</div>

<h3>ë¡œê·¸</h3>
<div id="log"></div>

<script>
  (() => {
    let accessToken = null;  // ë©”ëª¨ë¦¬ ì €ì¥ AT
    let refreshInFlight = null;

    const $ = (id) => document.getElementById(id);
    const baseUrlEl = $('baseUrl');
    const protectedPathEl = $('protectedPath');
    const logEl = $('log');
    const atPreviewEl = $('atPreview');

    function log(...args) {
      const line = args.map(x => typeof x === 'string' ? x : JSON.stringify(x, null, 2)).join(' ');
      logEl.textContent += line + '\n';
      logEl.scrollTop = logEl.scrollHeight;
      console.log(...args);
    }
    function setAT(token) {
      accessToken = token;
      atPreviewEl.textContent = accessToken ? (accessToken.slice(0, 16) + '...') : '(ì—†ìŒ)';
    }

    async function apiFetch(path, options = {}) {
      const base = baseUrlEl.value.replace(/\/+$/, '');
      const url = base + (path.startsWith('/') ? path : '/' + path);
      const headers = new Headers(options.headers || {});
      if (accessToken) headers.set('Authorization', 'Bearer ' + accessToken);

      const opts = {
        method: options.method || 'GET',
        headers,
        credentials: 'include',
        body: options.body ? JSON.stringify(options.body) : undefined,
      };
      if (options.body && !headers.has('Content-Type')) {
        headers.set('Content-Type', 'application/json');
      }

      let res = await fetch(url, opts);

      if (res.status === 401) {
        log('[apiFetch] 401 ê°ì§€ â†’ /auth/refresh ì‹œë„');
        await refreshOnce();
        headers.set('Authorization', 'Bearer ' + accessToken);
        res = await fetch(url, { ...opts, headers });
      }

      return res;
    }

    async function refreshOnce() {
      if (refreshInFlight) {
        log('[refresh] ì´ë¯¸ ì§„í–‰ ì¤‘ â†’ ê¸°ì¡´ Promise ê¸°ë‹¤ë¦¼');
        return refreshInFlight;
      }
      const base = baseUrlEl.value.replace(/\/+$/, '');
      const url = base + '/auth/refresh';
      const headers = new Headers({ 'Accept': 'application/json' });

      refreshInFlight = fetch(url, {
        method: 'POST',
        headers,
        credentials: 'include',
      })
              .then(async (res) => {
                if (!res.ok) {
                  const txt = await res.text().catch(() => '');
                  log('[refresh] ì‹¤íŒ¨', res.status, txt);
                  throw new Error('refresh failed ' + res.status);
                }
                const text = await res.text();
                let json;
                try { json = JSON.parse(text); } catch { json = null; }
                const at = json?.data?.accessToken || json?.accessToken || null;
                if (!at) {
                  log('[refresh] ì‘ë‹µì— accessToken ì—†ìŒ:', text);
                  throw new Error('no accessToken in response');
                }
                setAT(at);
                log('[refresh] ì„±ê³µ: ìƒˆ accessToken ìˆ˜ë ¹');
              })
              .catch(err => {
                setAT(null);
                log('[refresh] ì—ëŸ¬ â†’ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ìœ ë„ í•„ìš”:', err.message);
                throw err;
              })
              .finally(() => { refreshInFlight = null; });

      return refreshInFlight;
    }

    $('btnLogin').onclick = () => {
      const base = baseUrlEl.value.replace(/\/+$/, '');
      window.location.href = base + '/oauth2/authorization/google';
    };

    $('btnCall').onclick = async () => {
      try {
        const path = protectedPathEl.value.trim();
        const res = await apiFetch(path);
        const text = await res.text();
        log('í˜¸ì¶œ ì™„ë£Œ', res.status, text);
      } catch (e) {
        log('í˜¸ì¶œ ì—ëŸ¬', e.message);
      }
    };

    $('btnExpire').onclick = () => {
      setAT(null);
      log('ë©”ëª¨ë¦¬ì˜ accessToken ì œê±° â†’ ë‹¤ìŒ ìš”ì²­ì—ì„œ 401 ë°œìƒ ì˜ˆìƒ');
    };

    $('btnRefresh').onclick = async () => {
      try { await refreshOnce(); } catch (e) {}
    };

    $('btnShowCookies').onclick = () => {
      log('document.cookie =', document.cookie || '(ë¹„ì–´ìˆìŒ)');
      log('â€» HttpOnly ì¿ í‚¤(refreshToken)ëŠ” ë³´ì´ì§€ ì•ŠëŠ” ê²ƒì´ ì •ìƒì…ë‹ˆë‹¤.');
    };

    setAT(null);
  })();
</script>
</body>
</html>